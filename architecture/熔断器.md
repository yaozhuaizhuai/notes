**熔断器模式**

熔断器模式定义了熔断器开关相互转换的逻辑：

![](https://github.com/c-agam/notes/blob/master/images/%E7%86%94%E6%96%AD%E5%99%A8.png)

服务的健康状况 = 请求失败数 / 请求总数

熔断器开关由关闭到打开的状态转换是通过当前服务健康状况和设定阈值比较决定的
* 当熔断器开关关闭时, 请求被允许通过熔断器，
如果当前健康状况高于设定阈值, 开关继续保持关闭，
如果当前健康状况低于设定阈值, 开关则切换为打开状态。
* 当熔断器开关打开时, 请求被禁止通过。
* 当熔断器开关处于打开状态, 经过一段时间后, 熔断器会自动进入半开状态, 这时熔断器只允许一个请求通过, 当该请求调用成功时, 熔断器恢复到关闭状态, 若该请求失败, 熔断器继续保持打开状态, 接下来的请求被禁止通过。

**Hystrix**

![](https://github.com/c-agam/notes/blob/master/images/Hystrix.png)

1. 构建Hystrix的Command对象, 调用执行方法
2. Hystrix检查当前服务的熔断器开关是否开启, 若开启, 则执行降级服务getFallback方法
3. 若熔断器开关关闭, 则Hystrix检查当前服务的线程池是否能接收新的请求, 若超过线程池已满, 则执行降级服务getFallback方法
4. 若线程池接受请求, 则Hystrix开始执行服务调用具体逻辑run方法
5. 若服务执行失败, 则执行降级服务getFallback方法, 并将执行结果上报Metrics更新服务健康状况
6. 若服务执行超时, 则执行降级服务getFallback方法, 并将执行结果上报Metrics更新服务健康状况
7. 若服务执行成功, 返回正常结果
8. 若服务降级方法getFallback执行成功, 则返回降级结果
9. 若服务降级方法getFallback执行失败, 则抛出异常

Metrics中保存了当前服务的健康状况, 包括服务调用总次数和服务调用失败次数等。 根据Metrics的计数, 熔断器从而能计算出当前服务的调用失败率, 用来和设定的阈值比较从而决定熔断器的状态切换逻辑。
